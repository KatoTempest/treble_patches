From 2626da8975b5134951c940fe0fc10dbb3da5b4c2 Mon Sep 17 00:00:00 2001
From: Victor Bo <bvoid@yandex.ru>
Date: Fri, 27 Nov 2020 06:48:59 -0500
Subject: [PATCH 111/129] fix SystemUI crash from null stored in non-nullable

  from
  https://github.com/GrapheneOS/platform_frameworks_base/commit/645b62334fe5d1421adcf4304155bcbda2b42645
  https://github.com/GrapheneOS/platform_frameworks_base/commit/d3a1f5f34430c2f3aa42ff1f9ad0bc3f5e5d6f8f
---
 .../systemui/media/MediaDataManager.kt        | 22 +++++++++++--------
 1 file changed, 13 insertions(+), 9 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/media/MediaDataManager.kt b/packages/SystemUI/src/com/android/systemui/media/MediaDataManager.kt
index 299ae5b50aa..0ebad87a581 100644
--- a/packages/SystemUI/src/com/android/systemui/media/MediaDataManager.kt
+++ b/packages/SystemUI/src/com/android/systemui/media/MediaDataManager.kt
@@ -342,14 +342,16 @@ class MediaDataManager(
                         artWorkIcon.type == Icon.TYPE_ADAPTIVE_BITMAP) {
                     artworkBitmap = artWorkIcon.bitmap
                 } else {
-                    val drawable: Drawable = artWorkIcon.loadDrawable(context)
-                    artworkBitmap = Bitmap.createBitmap(
-                            drawable.intrinsicWidth,
-                            drawable.intrinsicHeight,
-                            Bitmap.Config.ARGB_8888)
-                    val canvas = Canvas(artworkBitmap)
-                    drawable.setBounds(0, 0, drawable.intrinsicWidth, drawable.intrinsicHeight)
-                    drawable.draw(canvas)
+                    val drawable: Drawable? = artWorkIcon.loadDrawable(context)
+                    if (drawable != null) {
+                        artworkBitmap = Bitmap.createBitmap(
+                                drawable.intrinsicWidth,
+                                drawable.intrinsicHeight,
+                                Bitmap.Config.ARGB_8888)
+                        val canvas = Canvas(artworkBitmap)
+                        drawable.setBounds(0, 0, drawable.intrinsicWidth, drawable.intrinsicHeight)
+                        drawable.draw(canvas)
+                    }
                 }
             }
         }
@@ -360,7 +362,9 @@ class MediaDataManager(
         val app = builder.loadHeaderAppName()
 
         // App Icon
-        val smallIconDrawable: Drawable = sbn.notification.smallIcon.loadDrawable(context)
+        // TODO: Look into why context is not for the right user. If current user is a secondary
+        //  user, context.userId is still 0, not the id of the current user.
+        val smallIconDrawable: Drawable? = sbn.notification.smallIcon.loadDrawable(context)
 
         // Song name
         var song: CharSequence? = metadata.getString(MediaMetadata.METADATA_KEY_DISPLAY_TITLE)
-- 
2.17.1

