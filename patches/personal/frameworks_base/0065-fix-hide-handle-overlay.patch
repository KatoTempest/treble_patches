From d762d499e17f079b6e0c3ba84b1bf7b555bb2287 Mon Sep 17 00:00:00 2001
From: Victor Bo <bvoid@yandex.ru>
Date: Mon, 16 Nov 2020 14:14:13 -0500
Subject: [PATCH 065/203] fix hide handle overlay

  based on
  https://github.com/Evolution-X/frameworks_base/commit/5dae6c827b308e35794a0d0d73e4e2a8a57344b5
  https://github.com/Evolution-X/vendor_evolution/commit/2914caf1e0ac463134f2428739d31d9690560305
---
 .../phone/NavigationModeController.java       | 14 +++++---
 .../AndroidManifest.xml                       |  2 +-
 .../res/values/bools.xml                      |  8 +++++
 .../res/values/dimens.xml                     | 34 ++++++++++++-------
 .../res/values/integers.xml                   |  5 +++
 5 files changed, 45 insertions(+), 18 deletions(-)
 create mode 100644 packages/overlays/GestureHandleHideOverlay/res/values/bools.xml
 create mode 100644 packages/overlays/GestureHandleHideOverlay/res/values/integers.xml

diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java
index c211de08cb8..46a0f36c40d 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java
@@ -59,6 +59,8 @@ public class NavigationModeController implements Dumpable {
     private static final String TAG = NavigationModeController.class.getSimpleName();
     private static final boolean DEBUG = true;
 
+    private static final String HIDE_OVERLAY_PKG = "com.android.theme.navbar.hidehandle";
+
     public interface ModeChangedListener {
         void onNavigationModeChanged(int mode);
     }
@@ -132,7 +134,9 @@ public class NavigationModeController implements Dumpable {
         mCurrentUserContext = getCurrentUserContext();
         int mode = getCurrentInteractionMode(mCurrentUserContext);
         if (mode == NAV_BAR_MODE_GESTURAL) {
-            switchToDefaultGestureNavOverlayIfNecessary();
+            boolean hidden = Settings.Secure.getFloat(mCurrentUserContext.getContentResolver(),
+                    Secure.GESTURE_NAVBAR_TUNING, 1.0f) == 0.0f;
+            switchToDefaultGestureNavOverlayIfNecessary(hidden);
         }
         mUiBgExecutor.execute(() ->
             Settings.Secure.putString(mCurrentUserContext.getContentResolver(),
@@ -187,18 +191,20 @@ public class NavigationModeController implements Dumpable {
         }
     }
 
-    private void switchToDefaultGestureNavOverlayIfNecessary() {
+    private void switchToDefaultGestureNavOverlayIfNecessary(boolean hidden) {
         final int userId = mCurrentUserContext.getUserId();
         try {
             final IOverlayManager om = IOverlayManager.Stub.asInterface(
                     ServiceManager.getService(Context.OVERLAY_SERVICE));
-            final OverlayInfo info = om.getOverlayInfo(NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
+            final OverlayInfo info = om.getOverlayInfo(hidden ? HIDE_OVERLAY_PKG :
+                                                       NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
             if (info != null && !info.isEnabled()) {
                 // Enable the default gesture nav overlay, and move the back gesture inset scale to
                 // Settings.Secure for left and right sensitivity.
                 final int curInset = mCurrentUserContext.getResources().getDimensionPixelSize(
                         com.android.internal.R.dimen.config_backGestureInset);
-                om.setEnabledExclusiveInCategory(NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
+                om.setEnabledExclusiveInCategory(hidden ? HIDE_OVERLAY_PKG :
+                                                 NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
                 final int defInset = mCurrentUserContext.getResources().getDimensionPixelSize(
                         com.android.internal.R.dimen.config_backGestureInset);
 
diff --git a/packages/overlays/GestureHandleHideOverlay/AndroidManifest.xml b/packages/overlays/GestureHandleHideOverlay/AndroidManifest.xml
index d5de4699a66..1dd3af64894 100644
--- a/packages/overlays/GestureHandleHideOverlay/AndroidManifest.xml
+++ b/packages/overlays/GestureHandleHideOverlay/AndroidManifest.xml
@@ -19,6 +19,6 @@
     package="com.android.theme.navbar.hidehandle"
     android:versionCode="1"
     android:versionName="1.0">
-    <overlay android:targetPackage="android" android:category="android.theme.customization.navbar" android:priority="1"/>
+    <overlay android:targetPackage="android" android:category="com.android.internal.navigation_bar_mode" android:priority="1"/>
     <application android:label="Hide" android:hasCode="false"/>
 </manifest>
diff --git a/packages/overlays/GestureHandleHideOverlay/res/values/bools.xml b/packages/overlays/GestureHandleHideOverlay/res/values/bools.xml
new file mode 100644
index 00000000000..8ecfc381681
--- /dev/null
+++ b/packages/overlays/GestureHandleHideOverlay/res/values/bools.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <bool name="config_allowSeamlessRotationDespiteNavBarMoving">true</bool>
+    <bool name="config_navBarAlwaysShowOnSideEdgeGesture">true</bool>
+    <bool name="config_navBarCanMove">false</bool>
+    <bool name="config_navBarNeedsScrim">false</bool>
+    <bool name="config_navBarTapThrough">true</bool>
+</resources>
diff --git a/packages/overlays/GestureHandleHideOverlay/res/values/dimens.xml b/packages/overlays/GestureHandleHideOverlay/res/values/dimens.xml
index 0c9414646c4..a27190d2723 100644
--- a/packages/overlays/GestureHandleHideOverlay/res/values/dimens.xml
+++ b/packages/overlays/GestureHandleHideOverlay/res/values/dimens.xml
@@ -1,18 +1,26 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!--
- * SPDX-License-Identifier: Apache-2.0
- * Copyright (C) 2020 The LineageOS Project
- * Copyright (C) 2020 The CAOS Project
+ * Copyright (c) 2006, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+*/
 -->
 <resources>
-    <!-- Height of the bottom navigation / system bar. -->
-    <dimen name="navigation_bar_height">0dp</dimen>
-    <!-- Height of the bottom navigation bar in portrait; often the same as @dimen/navigation_bar_height -->
-    <dimen name="navigation_bar_height_landscape">0dp</dimen>
-    <!-- Width of the navigation bar when it is placed vertically on the screen -->
-    <dimen name="navigation_bar_width">0dp</dimen>
-    <!-- Height of the bottom navigation / system bar. -->
-    <dimen name="navigation_bar_frame_height">0dp</dimen>
-    <!-- The height of the bottom navigation gesture area. -->
-    <dimen name="navigation_bar_gesture_height">24dp</dimen>
+    <dimen name="config_backGestureInset">24.0dip</dimen>
+    <dimen name="navigation_bar_frame_height">0.0dip</dimen>
+    <dimen name="navigation_bar_gesture_height">12.0dip</dimen>
+    <dimen name="navigation_bar_height">0.0dip</dimen>
+    <dimen name="navigation_bar_height_landscape">0.0dip</dimen>
+    <dimen name="navigation_bar_width">0.0dip</dimen>
+    <dimen name="navigation_bar_frame_height_landscape">0.0dip</dimen>
 </resources>
diff --git a/packages/overlays/GestureHandleHideOverlay/res/values/integers.xml b/packages/overlays/GestureHandleHideOverlay/res/values/integers.xml
new file mode 100644
index 00000000000..8c3e5baab3e
--- /dev/null
+++ b/packages/overlays/GestureHandleHideOverlay/res/values/integers.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <integer name="config_navBarInteractionMode">2</integer>
+    <integer name="config_navBarOpacityMode">2</integer>
+</resources>
-- 
2.17.1

