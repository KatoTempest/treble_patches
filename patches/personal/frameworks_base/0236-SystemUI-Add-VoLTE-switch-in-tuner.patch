From bb57f0ce71a85f34788d9f7901d197d66a02ed1a Mon Sep 17 00:00:00 2001
From: DennySPB <dennyspb@gmail.com>
Date: Tue, 1 Oct 2019 12:15:46 +0300
Subject: [PATCH 236/242] SystemUI: Add VoLTE switch in tuner

  with some changes

Change-Id: Ifd6527b2c88f17adbf7decc20b09367b6e8bb7e4
---
 .../SystemUI/res/values/custom_strings.xml    |  1 +
 packages/SystemUI/res/xml/tuner_prefs.xml     |  5 +++++
 .../policy/MobileSignalController.java        | 21 +++++++++++++++++--
 3 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/packages/SystemUI/res/values/custom_strings.xml b/packages/SystemUI/res/values/custom_strings.xml
index 9b95c3e66db..3171234a74d 100644
--- a/packages/SystemUI/res/values/custom_strings.xml
+++ b/packages/SystemUI/res/values/custom_strings.xml
@@ -52,5 +52,6 @@
     <!-- Name of the microphone status bar icon. -->
     <string name="status_bar_microphone">Microphone</string>
     <string name="status_bar_vpn">VPN</string>
+    <string name="status_bar_volte">VoLTE</string>
 
 </resources>
diff --git a/packages/SystemUI/res/xml/tuner_prefs.xml b/packages/SystemUI/res/xml/tuner_prefs.xml
index 6ca19f9ced0..9bfc66696b8 100644
--- a/packages/SystemUI/res/xml/tuner_prefs.xml
+++ b/packages/SystemUI/res/xml/tuner_prefs.xml
@@ -89,6 +89,11 @@
             android:key="airplane"
             android:title="@string/status_bar_airplane" />
 
+        <com.android.systemui.tuner.TunerSwitch
+            android:key="volte"
+            android:title="@string/status_bar_volte"
+            sysui:defValue="true" />
+
         <com.android.systemui.tuner.StatusBarSwitch
             android:key="vpn"
             android:title="@string/status_bar_vpn" />
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/policy/MobileSignalController.java b/packages/SystemUI/src/com/android/systemui/statusbar/policy/MobileSignalController.java
index de06eddaa71..31c5a6fcd05 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/policy/MobileSignalController.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/policy/MobileSignalController.java
@@ -52,10 +52,12 @@ import com.android.settingslib.Utils;
 import com.android.settingslib.graph.SignalDrawable;
 import com.android.settingslib.net.SignalStrengthUtil;
 import com.android.systemui.R;
+import com.android.systemui.Dependency;
 import com.android.systemui.statusbar.policy.NetworkController.IconState;
 import com.android.systemui.statusbar.policy.NetworkController.SignalCallback;
 import com.android.systemui.statusbar.policy.NetworkControllerImpl.Config;
 import com.android.systemui.statusbar.policy.NetworkControllerImpl.SubscriptionDefaults;
+import com.android.systemui.tuner.TunerService;
 
 import java.io.PrintWriter;
 import java.util.BitSet;
@@ -67,7 +69,7 @@ import java.util.concurrent.Executor;
 
 
 public class MobileSignalController extends SignalController<
-        MobileSignalController.MobileState, MobileSignalController.MobileIconGroup> {
+        MobileSignalController.MobileState, MobileSignalController.MobileIconGroup> implements TunerService.Tunable {
     private final TelephonyManager mPhone;
     private final SubscriptionDefaults mDefaults;
     private final String mNetworkNameDefault;
@@ -98,6 +100,7 @@ public class MobileSignalController extends SignalController<
     private ImsManager mImsManager;
     private FeatureConnector<ImsManager> mFeatureConnector;
     private int mCallState = TelephonyManager.CALL_STATE_IDLE;
+    private boolean mVolteIcon = true;
 
     // TODO: Reduce number of vars passed in, if we have the NetworkController, probably don't
     // need listener lists anymore.
@@ -119,6 +122,7 @@ public class MobileSignalController extends SignalController<
         mNetworkNameDefault = getTextIfExists(
                 com.android.internal.R.string.lockscreen_carrier_default).toString();
 
+        Dependency.get(TunerService.class).addTunable(this, "volte");
         mapIconSets();
 
         String networkName = info.getCarrierName() != null ? info.getCarrierName().toString()
@@ -161,6 +165,18 @@ public class MobileSignalController extends SignalController<
         };
     }
 
+    @Override
+    public void onTuningChanged(String key, String newValue) {
+        switch (key) {
+            case "volte":
+                     mVolteIcon =
+                        TunerService.parseIntegerSwitch(newValue, false);
+                        notifyListenersIfNecessary();
+            default:
+                break;
+        }
+    }
+
     public void setConfiguration(Config config) {
         mConfig = config;
         updateInflateSignalStrength();
@@ -505,7 +521,8 @@ public class MobileSignalController extends SignalController<
                 && mCurrentState.activityOut;
         showDataIcon &= mCurrentState.isDefault || dataDisabled;
         int typeIcon = (showDataIcon || mConfig.alwaysShowDataRatIcon) ? icons.mDataType : 0;
-        int volteIcon = mConfig.showVolteIcon && isVolteSwitchOn() ? getVolteResId() : 0;
+        int volteIcon = mConfig.showVolteIcon && isVolteSwitchOn() && mVolteIcon
+                ? getVolteResId() : 0;
         callback.setMobileDataIndicators(statusIcon, qsIcon, typeIcon, qsTypeIcon,
                 activityIn, activityOut, volteIcon, dataContentDescription, dataContentDescriptionHtml,
                 description, icons.mIsWide, mSubscriptionInfo.getSubscriptionId(),
-- 
2.30.2

