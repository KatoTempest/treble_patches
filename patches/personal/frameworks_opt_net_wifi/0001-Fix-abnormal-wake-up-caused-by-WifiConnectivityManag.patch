From 356dc410f73826503758a5a48d5fb8cc165d8f39 Mon Sep 17 00:00:00 2001
From: Victor Bo <bvoid@yandex.ru>
Date: Wed, 24 Mar 2021 08:27:31 -0400
Subject: [PATCH] Fix abnormal wake up caused by WifiConnectivityManager

  from
  https://github.com/crdroidandroid/android_frameworks_opt_net_wifi/commit/1590c968d37b78b8dfcd3cf21a80f380b7613166

Change-Id: I038d52c25a087f662f1e30d6f31c2369e28b0eae
---
 .../android/server/wifi/WifiConnectivityManager.java  | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/service/java/com/android/server/wifi/WifiConnectivityManager.java b/service/java/com/android/server/wifi/WifiConnectivityManager.java
index 77af65400..12c64b542 100644
--- a/service/java/com/android/server/wifi/WifiConnectivityManager.java
+++ b/service/java/com/android/server/wifi/WifiConnectivityManager.java
@@ -175,6 +175,7 @@ public class WifiConnectivityManager {
     private boolean mPnoScanStarted = false;
     private boolean mPeriodicScanTimerSet = false;
     private boolean mDelayedPartialScanTimerSet = false;
+    private boolean mWatchdogScanTimerSet = false;
 
     // Used for Initial Scan metrics
     private boolean mFailedInitialPartialScan = false;
@@ -1466,6 +1467,15 @@ public class WifiConnectivityManager {
                             mClock.getElapsedSinceBootMillis() + WATCHDOG_INTERVAL_MS,
                             WATCHDOG_TIMER_TAG,
                             mWatchdogListener, mEventHandler);
+        mWatchdogScanTimerSet = true;
+    }
+
+    // Cancel the watchdog scan timer.
+    private void cancelWatchdogScan() {
+        if (mWatchdogScanTimerSet) {
+            mAlarmManager.cancel(mWatchdogListener);
+            mWatchdogScanTimerSet = false;
+        }
     }
 
     // Schedules a delayed partial scan, which will scan the frequencies in mCachedWifiCandidates.
@@ -1893,6 +1903,7 @@ public class WifiConnectivityManager {
         if (!mRunning) return;
         mRunning = false;
         stopConnectivityScan();
+        cancelWatchdogScan();
         resetLastPeriodicSingleScanTimeStamp();
         mOpenNetworkNotifier.clearPendingNotification(true /* resetRepeatDelay */);
         mLastConnectionAttemptBssid = null;
-- 
2.17.1

