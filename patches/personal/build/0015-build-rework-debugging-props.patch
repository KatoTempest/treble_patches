From fc9c215c7a8cf312d4ef4a677334f1aea97bcfbd Mon Sep 17 00:00:00 2001
From: Victor Bo <bvoid@yandex.ru>
Date: Tue, 13 Apr 2021 18:58:22 -0400
Subject: [PATCH 15/15] build: rework debugging props

  based on
  https://github.com/BlissRoms/platform_build_make/commit/cfca08b80c2c375aa4319f74bc27e4a92b74ed67#

Change-Id: Id4e18e8b4af7d23c832e0eab47590234c8f10817
---
 core/main.mk              | 49 +++++++--------------------------------
 tools/buildinfo.sh        |  2 +-
 tools/buildinfo_common.sh |  2 +-
 3 files changed, 10 insertions(+), 43 deletions(-)

diff --git a/core/main.mk b/core/main.mk
index 357c70da3..79027bada 100644
--- a/core/main.mk
+++ b/core/main.mk
@@ -258,47 +258,14 @@ endif
 
 ## user/userdebug ##
 
-user_variant := $(filter user userdebug,$(TARGET_BUILD_VARIANT))
-enable_target_debugging := true
-tags_to_install :=
-ifneq (,$(user_variant))
-  # Target is secure in user builds.
-  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=1
-  ADDITIONAL_DEFAULT_PROPERTIES += security.perf_harden=1
-
-  ifeq ($(user_variant),user)
-    ADDITIONAL_DEFAULT_PROPERTIES += ro.adb.secure=1
-  endif
-
-  ifeq ($(user_variant),userdebug)
-    # Pick up some extra useful tools
-    tags_to_install += debug
-  else
-    # Disable debugging in plain user builds.
-    enable_target_debugging :=
-  endif
-
-  # Disallow mock locations by default for user builds
-  ADDITIONAL_DEFAULT_PROPERTIES += ro.allow.mock.location=0
-
-else # !user_variant
-  # Turn on checkjni for non-user builds.
-  ADDITIONAL_BUILD_PROPERTIES += ro.kernel.android.checkjni=1
-  # Set device insecure for non-user builds.
-  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=0
-  # Allow mock locations by default for non user builds
-  ADDITIONAL_DEFAULT_PROPERTIES += ro.allow.mock.location=1
-endif # !user_variant
-
-ifeq (true,$(strip $(enable_target_debugging)))
-  # Target is more debuggable and adbd is on by default
-  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=1
-  # Enable Dalvik lock contention logging.
-  ADDITIONAL_BUILD_PROPERTIES += dalvik.vm.lockprof.threshold=500
-else # !enable_target_debugging
-  # Target is less debuggable and adbd is off by default
-  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=0
-endif # !enable_target_debugging
+user_variant := user
+enable_target_debugging :=
+tags_to_install += debug
+
+ADDITIONAL_BUILD_PROPERTIES += ro.kernel.android.checkjni=1
+ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=0
+ADDITIONAL_DEFAULT_PROPERTIES += ro.allow.mock.location=1
+ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=1
 
 ## eng ##
 
diff --git a/tools/buildinfo.sh b/tools/buildinfo.sh
index 9bee11548..8d7fc999b 100755
--- a/tools/buildinfo.sh
+++ b/tools/buildinfo.sh
@@ -18,7 +18,7 @@ echo "ro.build.version.base_os=$PLATFORM_BASE_OS"
 echo "ro.build.version.min_supported_target_sdk=$PLATFORM_MIN_SUPPORTED_TARGET_SDK_VERSION"
 echo "ro.build.date=`$DATE`"
 echo "ro.build.date.utc=`$DATE +%s`"
-echo "ro.build.type=$TARGET_BUILD_TYPE"
+echo "ro.build.type=user"
 echo "ro.build.user=$BUILD_USERNAME"
 echo "ro.build.host=$BUILD_HOSTNAME"
 echo "ro.build.tags=$BUILD_VERSION_TAGS"
diff --git a/tools/buildinfo_common.sh b/tools/buildinfo_common.sh
index 673e06f3d..8ec2a5823 100755
--- a/tools/buildinfo_common.sh
+++ b/tools/buildinfo_common.sh
@@ -15,7 +15,7 @@ echo "ro.${partition}.build.date.utc=`$DATE +%s`"
 echo "ro.${partition}.build.fingerprint=$BUILD_FINGERPRINT"
 echo "ro.${partition}.build.id=$BUILD_ID"
 echo "ro.${partition}.build.tags=$BUILD_VERSION_TAGS"
-echo "ro.${partition}.build.type=$TARGET_BUILD_TYPE"
+echo "ro.${partition}.build.type=user"
 echo "ro.${partition}.build.version.incremental=$BUILD_NUMBER"
 echo "ro.${partition}.build.version.release=$PLATFORM_VERSION_LAST_STABLE"
 echo "ro.${partition}.build.version.release_or_codename=$PLATFORM_VERSION"
-- 
2.17.1

